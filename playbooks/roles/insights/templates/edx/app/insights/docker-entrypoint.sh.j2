#!/usr/bin/env bash

# {{ ansible_managed }}

set -e

export DEVSTACK_HOST="${DEVSTACK_HOST:-open.edx}"

cat >/ansible_overrides.yml <<EOL
---
migrate_db: yes
DEVSTACK_HOST: ${DEVSTACK_HOST}
INSIGHTS_LMS_BASE: "http://${DEVSTACK_HOST}:8000"
INSIGHTS_CMS_BASE: "http://${DEVSTACK_HOST}:8010"
INSIGHTS_BASE_URL: "http://${DEVSTACK_HOST}:8110"
INSIGHTS_MEMCACHE:
  - "${INSIGHTS_MEMCACHE:-memcache:11211}"
ANALYTICS_API_ENDPOINT: "${ANALYTICS_API_ENDPOINT:-http://analyticsapi:8100/api/v0}"
COMMON_MYSQL_MIGRATE_USER: ${COMMON_MYSQL_MIGRATE_USER:-root}
COMMON_MYSQL_MIGRATE_PASS: ${COMMON_MYSQL_MIGRATE_PASS:-}

INSIGHTS_DATABASES:
  # rw user
  default:
    ENGINE: 'django.db.backends.mysql'
    NAME: 'dashboard'
    USER: 'insights001'
    PASSWORD: 'password'
    HOST: '${INSIGHTS_DATABASE_HOST:-resultstore}'
    PORT: '${INSIGHTS_DATABASE_PORT:-3306}'

EOL

echo "Initializing the runtime environment"
/edx/app/edx_ansible/venvs/edx_ansible/bin/ansible-playbook insights.yml \
    -i '127.0.0.1,' -c local \
    -t "install:app-configuration,devstack:start" \
    --extra-vars="@/ansible_overrides.yml"

/edx/app/supervisor/venvs/supervisor/bin/supervisord --configuration /edx/app/supervisor/supervisord.conf

exec "$@"